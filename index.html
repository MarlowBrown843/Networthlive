document.addEventListener("DOMContentLoaded", async () => {
  const supabaseUrl = "https://jeoapkxwouaszaehiapy.supabase.co";
  const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // Handle magic link token in URL
  const { error: urlError } = await supabase.auth.getSessionFromUrl();

  // Then check if session is active
  const { data: { session } } = await supabase.auth.getSession();

  if (session) {
    document.getElementById('auth').classList.add('hidden');
    document.getElementById('app').classList.remove('hidden');
    startApp();
  }

  document.getElementById("authButton").addEventListener("click", async () => {
    const email = document.getElementById("email").value;
    const { error } = await supabase.auth.signInWithOtp({ email });
    document.getElementById("authMessage").innerText = error ? error.message : "Magic link sent! Check your email.";
  });

  let netWorth = 6000;
  let passiveGrowthPerSecond = 0.03;
  let chart = null;

  function formatMoney(value) {
    return "$" + value.toLocaleString(undefined, { minimumFractionDigits: 3, maximumFractionDigits: 3 });
  }

  function startApp() {
    const ctx = document.getElementById('netWorthChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: [],
        datasets: [{
          label: 'Net Worth',
          borderColor: '#111',
          backgroundColor: '#ccc',
          data: [],
          fill: true,
          tension: 0.4,
        }]
      },
      options: {
        animation: false,
        scales: {
          x: { display: false },
          y: { beginAtZero: true }
        }
      }
    });

    setInterval(() => {
      netWorth += passiveGrowthPerSecond;
      document.getElementById("counter").innerText = formatMoney(netWorth);

      const now = new Date();
      chart.data.labels.push(now.toLocaleTimeString());
      chart.data.datasets[0].data.push(netWorth);
      if (chart.data.labels.length > 50) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift();
      }
      chart.update();
    }, 1000);
  }
});
